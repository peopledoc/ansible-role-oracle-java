---

- name: Add Java 8 repository
  apt_repository:
    repo: deb http://ppa.launchpad.net/webupd8team/java/ubuntu precise main

- name: Install Java 8 Key (also belongs to VLC)
  tags: debug
  apt_key:
    id: EEA14886
    keyserver: keyserver.ubuntu.com
  register: java8_apt_key

- apt:
    update_cache: yes
  when: java8_apt_key.changed
  
- name: Install debconf-utils
  apt:
    name: debconf-utils

- name: Read license
  shell: echo debconf shared/accepted-oracle-license-v1-1 select true | debconf-set-selections && touch /root/.oracle-license-seen
  args:
    creates: /root/.oracle-license-seen

- name: Accept license
  shell: echo debconf shared/accepted-oracle-license-v1-1 seen true | debconf-set-selections && touch /root/.oracle-license-accepted
  args:
    creates: /root/.oracle-license-accepted

- name: Patch the java installer due to some Oracle changes on their website
  shell: |
    cd /var/lib/dpkg/info
    sed -i 's|JAVA_VERSION=8u151|JAVA_VERSION=8u162|' oracle-java8-installer.*
    sed -i 's|PARTNER_URL=http://download.oracle.com/otn-pub/java/jdk/8u151-b12/e758a0de34e24606bca991d704f6dcbf/|PARTNER_URL=http://download.oracle.com/otn-pub/java/jdk/8u162-b12/0da788060d494f5095bf8624735fa2f1/|' oracle-java8-installer.*
    sed -i 's|SHA256SUM_TGZ="c78200ce409367b296ec39be4427f020e2c585470c4eed01021feada576f027f"|SHA256SUM_TGZ="68ec82d47fd9c2b8eb84225b6db398a72008285fafc98631b1ff8d2229680257"|' oracle-java8-installer.*
    sed -i 's|J_DIR=jdk1.8.0_151|J_DIR=jdk1.8.0_162|' oracle-java8-installer.*

- name: Install java installer
  apt: name={{ item }}
  with_items: 
  - oracle-java8-installer
  - oracle-java8-set-default

- name: Install Java Cryptography Extension
  apt: name=oracle-java8-unlimited-jce-policy
  when: '{{ install_cryptography_extension }}'
